---
title: "Kakcus-TurjÃ¡n"
author: "Clemens Schmid"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Spit attribution for small scale excavations}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo=FALSE}
if (!requireNamespace("plotly", quietly = TRUE)) {
  stop("plotly needed for this vignette to build.",
    call. = FALSE)
}
```

First we need to load recexcavAAR and some external packages:

- **dplyr**: filter function
- **kriging**: simple surface modelling tool
- **magrittr**: introduces piping to R via %>% operator
- **plotly**: nice, interactive plots via javascript implementation

```{r, message=FALSE}
devtools::load_all()
library(dplyr)
library(kriging)
library(magrittr)
library(plotly)
```

Like in the first vignette `Ifri el Baroud` we start by setting up an artificial and pretty simple excavation trench with a depth of 1.4 meters, a length of 6 meters and a width of 8 meters. This one is not parallel to the main axis of our coordinate system. 

```{r}
edges <- data.frame(
  x = c(6.899, 10.658, 4.428, 0.669, 6.899, 10.658, 4.428, 0.669),
  y = c(19.292, 14.616, 9.597, 14.273, 19.292, 14.616, 9.597, 14.273),
  z = c(9.7, 9.7, 9.7, 9.7, 8.3, 8.3, 8.3, 8.3)
)
```

We can plot the corner points of this trench, but first of all, we have to calculate a reasonable aspectratio. Remember: The trench is tilted in relation to the main axis. 

```{r fig.width=7, fig.height=5}
rangex <- abs(max(edges$x) - min(edges$x))
rangey <- abs(max(edges$y) - min(edges$y))

vis <- plot_ly(
  edges, x = x, y = y, z = z, 
  type = "scatter3d", mode = "markers",
  marker = list(size = 2, color = "blue", symbol = 104)
) %>% 
  layout(
    showlegend = FALSE,
    autorange = F, 
    aspectmode = 'manual', 
    scene = list(
      dragmode = "orbit",
      aspectratio = list(x = rangex, y = rangey, z = 5),
      camera = list(
        eye = list(x = -7, y = 7, z = 9) 
      )
    )
  ) 

vis
```

The approach for the excavation of this trench is to go deeper in squares of 1 meter by 1 meter. The spit depth is about 30 centimeters, but as we also try to follow natural layers, the individual spit depth varies a lot. Fortunately we have niveau measurements of the resulting surfaces in the dataset `KT_spits`. 

```{r}
sp <- KT_spits

splist <- list()
spitnames <- c("^surface", "^spit1", "^spit2", "^spit3", "^bottom")

for (i in 1:length(spitnames)){
  splist[[i]] <- sp[grep(spitnames[i], sp$id), ]
}
```

Let's apply kriging with `kriglist`, transform the result with `spatialwide2` and add the surfaces to the plot. 

```{r fig.width=7, fig.height=5}
maps <- kriglist(splist, x = 2, y = 3, z = 4, lags = 3, model = "spherical")

surf <- list()
for (i in 1:length(maps)) {
  surf[[i]] <- spatialwide2(maps[[i]]$x, maps[[i]]$y, maps[[i]]$pred, digits = 3)
}

vis %>% 
  add_trace(x = surf[[1]]$x, y = surf[[1]]$y, z = surf[[1]]$z, type = "surface", 
            showscale = FALSE, opacity = 0.9, hoverinfo = "none"
  ) %>%
  add_trace(x = surf[[2]]$x, y = surf[[2]]$y, z = surf[[2]]$z, type = "surface", 
            showscale = FALSE, opacity = 0.9, hoverinfo = "none"
  ) %>%
  add_trace(x = surf[[3]]$x, y = surf[[3]]$y, z = surf[[3]]$z, type = "surface", 
            showscale = FALSE, opacity = 0.9, hoverinfo = "none"
  ) %>%
  add_trace(x = surf[[4]]$x, y = surf[[4]]$y, z = surf[[4]]$z, type = "surface", 
            showscale = FALSE, opacity = 0.9, hoverinfo = "none"
  ) %>%
  add_trace(x = surf[[5]]$x, y = surf[[5]]$y, z = surf[[5]]$z, type = "surface", 
            showscale = FALSE, opacity = 0.9, hoverinfo = "none"
  ) 
```

Hm... ok. But the surfaces extend beyond the surfaces of the trench... We can use `pnpmulti` to decide which points of the kriging result are within the trench polygon. Then we can remove the others and plot the result again.

```{r fig.width=7, fig.height=5}
for (i in 1:length(maps)) {
  rem <- recexcavAAR::pnpmulti(edges$x[1:4], edges$y[1:4], maps[[i]]$x, maps[[i]]$y)
  maps[[i]] <- maps[[i]][rem, ]
}

surf2 <- list()
for (i in 1:length(maps)) {
  surf2[[i]] <- recexcavAAR::spatialwide2(maps[[i]]$x, maps[[i]]$y, maps[[i]]$pred, 3)
}

vis <- vis %>% 
  add_trace(x = surf2[[1]]$x, y = surf2[[1]]$y, z = surf2[[1]]$z, type = "surface", 
            showscale = FALSE, opacity = 0.9, hoverinfo = "none"
  ) %>%
  add_trace(x = surf2[[2]]$x, y = surf2[[2]]$y, z = surf2[[2]]$z, type = "surface", 
            showscale = FALSE, opacity = 0.9, hoverinfo = "none"
  ) %>%
  add_trace(x = surf2[[3]]$x, y = surf2[[3]]$y, z = surf2[[3]]$z, type = "surface", 
            showscale = FALSE, opacity = 0.9, hoverinfo = "none"
  ) %>%
  add_trace(x = surf2[[4]]$x, y = surf2[[4]]$y, z = surf2[[4]]$z, type = "surface", 
            showscale = FALSE, opacity = 0.9, hoverinfo = "none"
  ) %>%
  add_trace(x = surf2[[5]]$x, y = surf2[[5]]$y, z = surf2[[5]]$z, type = "surface", 
            showscale = FALSE, opacity = 0.9, hoverinfo = "none"
  ) 

vis
```

Now to the actual task: During the excavation we found a lot of pottery from all over the trench. Many of the individual sherds fit together.